<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team | CBD Teams</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bitcount+Single:wght@100..900&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse shadow-sm vh-100 position-fixed">
            <div class="position-sticky pt-3">
                <div class="px-3 mb-4">
                    <h1 class="fw-bold head logo" style="color: #cea530;">CBD</h1>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="/index"><i class="bi bi-house-door me-2"></i> My Activities</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-briefcase-fill me-2"></i> My Actions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-kanban me-2"></i> Projects</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-bookmarks-fill me-2"></i> Reports</a>
                    </li>
                    <li class="nav-item"><a class="nav-link active" href="/team"><i class="bi bi-people me-2"></i> Team</a></li>
                    <li class="nav-item"><a class="nav-link" href="/settings"><i class="bi bi-gear me-2"></i> Settings</a></li>
                </ul>
                <div class="mt-5 px-3">
                    <a href="/logout" class="btn btn-outline-danger btn-sm w-100">Logout</a>
                </div>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 bg-light min-vh-100">
            <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h4 fw-bold">Team Directory</h1>
                <div class="text-muted small">Viewing all registered staff</div>
            </div>

            <div class="card border-0 shadow-sm mt-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th class="ps-4">Staff Member</th>
                            <th>Staff ID</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Action</th>
                        </tr>
                        </thead>
                        <tbody id="teamList">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    async function loadTeam() {
    try {
        const response = await fetch('/api/staff/list');
        const staffMembers = await response.json();
        const teamList = document.getElementById('teamList');

        teamList.innerHTML = staffMembers.map(staff => {
            // Logic for Status Colors
            // If status is null (new user), default to 'Active'
            const currentStatus = staff.status || 'Active';
            const isClosed = currentStatus === 'Closed';

            // Badge Color: success for Active, danger for Closed
            const badgeClass = isClosed ? 'bg-danger' : 'bg-success';

            // Button Logic: If closed, show 're-activate' icon. If active, show 'power-off' icon.
            const btnClass = isClosed ? 'btn-outline-success' : 'btn-outline-danger';
            const btnIcon = isClosed ? 'bi-arrow-clockwise' : 'bi-power';
            const btnTitle = isClosed ? 'Activate User' : 'Close User';

            return `
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <img src="${staff.imagePath || '/images/default-avatar.png'}"
                                 class="rounded-circle me-3 border" width="35" height="35" style="object-fit: cover;">
                            <span class="fw-semibold text-dark">${staff.name}</span>
                        </div>
                    </td>
                    <td><span class="badge bg-light text-primary border">${staff.staffId}</span></td>
                    <td>
                        <span class="badge ${badgeClass}">${currentStatus}</span>
                    </td>
                    <td class="text-end pe-4">

                        <button class="btn btn-sm ${btnClass}"
                                onclick="toggleStatus('${staff.staffId}', '${currentStatus}')"
                                title="${btnTitle}">
                            <i class="bi ${btnIcon}"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error("Failed to load team data", error);
    }
}

// Function to handle the toggle
async function toggleStatus(staffId, currentStatus) {
    const newStatus = (currentStatus === 'Active') ? 'Closed' : 'Active';

    if (confirm(`Set user ${staffId} to ${newStatus}?`)) {
        const formData = new FormData();
        formData.append('staffId', staffId);
        formData.append('status', newStatus);

        try {
            const response = await fetch('/api/staff/update-status', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                loadTeam(); // Reload the table to see color changes
            } else {
                alert("Error updating status");
            }
        } catch (err) {
            console.error(err);
        }
    }
}

function editUser(id) {
    // Logic for opening an edit modal
    console.log("Editing " + id);
}

window.onload = loadTeam;
</script>
</body>
</html>